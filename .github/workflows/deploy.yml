name: CD - Deploy to GCP

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GCP_HOST }}
        username: ${{ secrets.GCP_USERNAME }}
        key: ${{ secrets.GCP_SSH_KEY }}
        envs: SECRET_KEY,OPENROUTER_API_KEY,BREVO_API_KEY,ADMIN_PASSWORD
        script: |
          echo "Starting Deployment..."
          cd DocsSite

          echo "Pulling latest code..."
          git pull origin main

          echo "Creating .env file..."
          cat > .env << 'ENVEOF'
          # Flask configuration
          SECRET_KEY=${{ secrets.SECRET_KEY }}

          # File limits
          MAX_FILE_SIZE=52428800

          # Rate limiting
          RATE_LIMIT_REQUESTS=200
          RATE_LIMIT_WINDOW=60

          # Email Configuration - Brevo API
          CONTACT_EMAIL=paulo@paulocadias.com
          SMTP_SERVER=smtp-relay.brevo.com
          SMTP_PORT=587
          SMTP_USERNAME=${{ secrets.BREVO_API_KEY }}
          SMTP_PASSWORD=${{ secrets.BREVO_API_KEY }}
          SMTP_SENDER=paulo@paulocadias.com

          # OpenRouter (for chat features)
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}

          # Admin
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}

          # Logging
          LOG_LEVEL=INFO
          ENVEOF

          echo "Running deployment script..."
          chmod +x deploy.sh
          ./deploy.sh

          echo "Deployment Complete!"
