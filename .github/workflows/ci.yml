name: CI - Test & Quality

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: Test & Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests flake8 bandit

    - name: Linting (Flake8)
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Security Scan (Bandit)
      run: |
        bandit -r src/ -ll

    - name: Start Application (Background)
      env:
        SECRET_KEY: "ci-test-key"
        MAX_FILE_SIZE: 52428800
      run: |
        python src/app.py &
        echo "Waiting for server to start on port 8080..."
        for i in {1..30}; do
          if curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo "Server is ready!"
            break
          fi
          echo "Attempt $i: Server not ready, waiting..."
          sleep 1
        done

    - name: Run Verification Script
      run: |
        python tests/verify_deployment.py
