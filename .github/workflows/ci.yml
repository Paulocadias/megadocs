name: CI - Test & Verify

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: Run System Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests

    - name: Start Application (Background)
      env:
        SECRET_KEY: "ci-test-key"
        MAX_FILE_SIZE: 52428800
      run: |
        # Start Flask app in background
        python src/app.py &
        echo "Waiting for server to start on port 8080..."
        # Wait for server to be ready (up to 30 seconds)
        for i in {1..30}; do
          if curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo "Server is ready!"
            break
          fi
          echo "Attempt $i: Server not ready, waiting..."
          sleep 1
        done

    - name: Run Verification Script
      run: |
        python tests/verify_deployment.py
